FROM debian:bookworm-slim

ENV DEBIAN_FRONTEND=noninteractive

# Add VitexSoftware repository
RUN apt-get update && apt-get install -y \
    wget \
    lsb-release \
    apt-transport-https \
    gpg \
    && wget -O /usr/share/keyrings/repo.vitexsoftware.com.gpg http://repo.vitexsoftware.com/KEY.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/repo.vitexsoftware.com.gpg] http://repo.vitexsoftware.com $(lsb_release -sc) main backports" | tee /etc/apt/sources.list.d/vitexsoftware.list \
    && apt-get update

# Install MultiFlexi executor package
RUN apt-get install -y \
    multiflexi-executor \
    && rm -rf /var/lib/apt/lists/*

# Create multiflexi user and group (matching systemd service)
RUN groupadd -r multiflexi || true && id -u multiflexi || useradd -r -g multiflexi multiflexi

# Create required directories
RUN mkdir -p /etc/multiflexi && chown multiflexi:multiflexi /etc/multiflexi

# Set working directory
WORKDIR /opt/multiflexi

# Switch to multiflexi user
USER multiflexi

# Run the executor daemon (matching systemd ExecStart)
CMD ["/usr/bin/php", "/usr/lib/multiflexi-executor/daemon.php"]
